generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

////////////////////
/// ENUMS
////////////////////

enum ItemCategory {
  SERENITY_GROUND
  SERVICE
}

enum PurchaseType {
  IMMEDIATE
  FUTURE
}

enum FutureFor {
  SELF
  OTHER
}

enum PurchaseStatus {
  PENDING_PAYMENT
  PARTIALLY_PAID
  PAID
  CANCELLED
}

enum PaymentStatus {
  INITIATED
  SUCCESS
  FAILED
  EXPIRED
}

enum PricingSection {
  MUHACHA
  LAWN
  DONHODZO
  FAMILY
}

enum BurialStatus {
  PENDING_WAIVER_APPROVAL
  PENDING_GRAVE_ASSIGNMENT
  GRAVE_ASSIGNED
  BURIED
}

enum WaiverStatus {
  PENDING
  APPROVED
  REJECTED
}

enum WaiverType {
  DONATION
  SPECIAL_CASE
}

enum AssignmentRequestStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
}

enum CommissionStatus {
  PENDING
  ISSUED
}

enum StaffType {
  SITE
  OFFICE
  PASTORAL
}

enum SmsOutboxEventType {
  BURIAL_READY_NOTIFY_TEAMS
  DEBTOR_MONTHLY_REMINDER
}

enum SmsCategory {
  OPS
  PASTORAL
  DEBTOR
}

enum SmsStatus {
  QUEUED
  SENT
  DELIVERED
  FAILED
}

////////////////////
/// CORE MODELS
////////////////////

model Product {
  id             String          @id @default(uuid()) @db.Uuid
  category       ItemCategory
  title          String
  slug           String?         @unique
  priceText      String?
  amount         Decimal         @db.Decimal(10, 2)
  currency       String
  description    String?         @db.Text
  imagePath      String?
  sku            String?
  pricingSection PricingSection?
  active         Boolean         @default(true)
  orderNum       Int             @default(0)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  purchases   Purchase[]
  isAvailable Boolean    @default(true)

  @@index([category, orderNum])
  @@map("items")
}

////////////////////
/// STAFF (ADMIN WEB)
////////////////////

model Staff {
  id          String        @id @default(cuid())
  firstName   String
  lastName    String
  email       String        @unique
  phone       String
  nationalId  String        @unique
  dateOfBirth DateTime
  address     String

  /// Staff type: SITE, OFFICE, or PASTORAL
  staffType   StaffType    @default(OFFICE)

  /// Numeric level used for authorization:
  /// 1 = general worker
  /// 2 = supervisor
  /// 3 = accountant
  /// 4 = head
  /// 5 = managing director
  level Int

  /// System-wide admin (overall seer). Only true for one or very few users.
  isSystemAdmin Boolean @default(false)

  /// Whether this staff account is allowed to log in
  isActive Boolean @default(true)

  /// Whether this staff account has been approved by a system admin
  isApproved Boolean @default(false)

  /// Securely hashed password
  password String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  commissionsAsAgent Commission[] @relation
  commissionsAsApprover Commission[] @relation("CommissionApprover")

  @@index([email])
  @@index([level])
  @@index([staffType])
  @@index([isActive, staffType])
}

model Member {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  country     String
  address     String
  city        String
  email       String   @unique
  phone       String
  password    String
  nationalId  String?  @unique
  dateOfBirth DateTime
  gender      String?

  expoPushToken String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchases Purchase[]
  payments  Payment[]
  nextOfKin NextOfKin?

  @@index([email])
}

////////////////////
/// PURCHASE
////////////////////

model Purchase {
  id        String @id @default(uuid()) @db.Uuid
  memberId  String
  productId String @db.Uuid

  purchaseType PurchaseType
  futureFor    FutureFor?

  totalAmount Decimal @db.Decimal(10, 2)
  paidAmount  Decimal @default(0) @db.Decimal(10, 2)
  balance     Decimal @db.Decimal(10, 2)

  status PurchaseStatus @default(PENDING_PAYMENT)

  paidAt DateTime?

  nextDueAt       DateTime?
  lastPaidAt      DateTime?
  completedAt     DateTime?
  reminderEnabled Boolean?  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  member  Member  @relation(fields: [memberId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  payments Payment[]
  deceased Deceased?

  redeemedByMemberId String?
  redeemedAt         DateTime?

  yearPlanId Int?
  yearPlan   YearPlan? @relation(fields: [yearPlanId], references: [id])

  graveSlot GraveSlot?
  commission Commission?

  @@index([memberId])
  @@index([memberId, status])
  @@index([memberId, createdAt])
}

////////////////////
/// PAYMENTS
////////////////////

model Payment {
  id         String @id @default(uuid()) @db.Uuid
  purchaseId String @db.Uuid
  memberId   String

  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("USD")
  method   String  @default("PAYNOW")

  reference String        @unique
  status    PaymentStatus @default(INITIATED)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  paidAt    DateTime?
  pollUrl   String?

  purchase Purchase @relation(fields: [purchaseId], references: [id])
  member   Member   @relation(fields: [memberId], references: [id])

  @@index([memberId])
  @@index([memberId, createdAt])
  @@index([purchaseId])
  @@index([status])
}

////////////////////
/// USAGE MODELS
////////////////////

model Deceased {
  id         String @id @default(uuid()) @db.Uuid
  purchaseId String? @unique @db.Uuid

  fullName       String
  dateOfBirth    DateTime?
  gender         String
  address        String
  relationship   String
  causeOfDeath   String?
  funeralParlor  String?
  dateOfDeath    DateTime
  expectedBurial DateTime?
  burialDate     DateTime?
  notes           String? @db.Text

  status BurialStatus @default(PENDING_GRAVE_ASSIGNMENT)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  createdBy String? // Staff ID who created the record

  // Tracking fields for burial workflow
  purchaseLinkedAt   DateTime? // When purchase was linked
  deceasedCapturedAt DateTime? // When all required deceased details were captured
  smsNotifiedAt      DateTime? // When SMS notification was sent

  purchase Purchase? @relation(fields: [purchaseId], references: [id])
  waiver   Waiver?
  graveSlot GraveSlot?
  nextOfKin BurialNextOfKin?

  assignmentRequests AssignmentRequest[]

  @@index([purchaseId])
  @@index([status])
  @@index([burialDate])
  @@index([expectedBurial])
}

model NextOfKin {
  id       String @id @default(uuid()) @db.Uuid
  memberId String @unique

  fullName     String
  relationship String
  phone        String
  email        String?
  address      String

  member Member @relation(fields: [memberId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([memberId])
}

model YearPlan {
  id       Int    @id @default(autoincrement())
  name     String @unique
  currency String @default("USD")
  months   Int

  muhacha_under60 Decimal  @db.Decimal(10, 2)
  muhacha_over60  Decimal? @db.Decimal(10, 2)

  lawn_under60 Decimal  @db.Decimal(10, 2)
  lawn_over60  Decimal? @db.Decimal(10, 2)

  donhodzo_under60 Decimal  @db.Decimal(10, 2)
  donhodzo_over60  Decimal? @db.Decimal(10, 2)

  family_under60 Decimal  @db.Decimal(10, 2)
  family_over60  Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchases Purchase[]

  @@map("year_plans")
}

model Upcoming {
  id          Int    @id @default(autoincrement())
  heading     String
  description String
  imagePath   String
  orderNum    Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderNum])
  @@map("upcoming")
}

////////////////////
/// BURIALS MODULE
////////////////////

model Grave {
  id          String @id @default(uuid()) @db.Uuid
  section     PricingSection
  graveNumber String
  capacity    Int    @default(2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  slots GraveSlot[]

  @@unique([section, graveNumber])
  @@index([section, graveNumber])
}

model GraveSlot {
  id         String @id @default(uuid()) @db.Uuid
  graveId    String @db.Uuid
  slotNo     Int // 1 or 2
  purchaseId String? @db.Uuid // Nullable for waiver-funded burials
  deceasedId String? @unique @db.Uuid // Foreign key to Deceased

  priceAtPurchase Decimal? @db.Decimal(10, 2) // Store pricing for audit (Slot 1 = FULL, Slot 2 = 10% discount)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  grave    Grave    @relation(fields: [graveId], references: [id])
  purchase Purchase? @relation(fields: [purchaseId], references: [id])
  deceased Deceased? @relation(fields: [deceasedId], references: [id])

  @@unique([graveId, slotNo])
  @@unique([purchaseId]) // One purchase can only be used once
  @@index([graveId])
  @@index([purchaseId])
  @@index([deceasedId])
}

model Waiver {
  id         String @id @default(uuid()) @db.Uuid
  deceasedId String @unique @db.Uuid

  waiverType WaiverType
  reason     String @db.Text
  status     WaiverStatus @default(PENDING)

  approvedBy   String? // Staff ID (Level 5)
  approvedAt   DateTime?
  rejectedBy   String? // Staff ID
  rejectedAt   DateTime?
  rejectionReason String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deceased Deceased @relation(fields: [deceasedId], references: [id])

  @@index([status])
  @@index([deceasedId])
}

model AssignmentRequest {
  id         String @id @default(uuid()) @db.Uuid
  deceasedId String @db.Uuid

  requestedSection PricingSection?
  status           AssignmentRequestStatus @default(PENDING)

  requestedBy String // Staff ID
  assignedBy  String? // Staff ID (site operations)
  assignedAt  DateTime?

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deceased Deceased @relation(fields: [deceasedId], references: [id])

  @@index([deceasedId])
  @@index([status])
  @@index([requestedBy])
}

model BurialNextOfKin {
  id         String @id @default(uuid()) @db.Uuid
  deceasedId String @unique @db.Uuid

  fullName     String
  relationship String
  phone        String
  email        String?
  address      String

  isBuyer Boolean @default(false) // Whether this is the purchase buyer

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deceased Deceased @relation(fields: [deceasedId], references: [id])

  @@index([deceasedId])
}

////////////////////
/// COMMISSIONS
////////////////////

model Commission {
  id              String          @id @default(uuid()) @db.Uuid
  purchaseId      String          @unique @db.Uuid
  agentName       String
  company         String          // "Etosha" for internal staff, or parlour name
  agentStaffId    String?         // Link to Staff if it's an Etosha staff member
  saleDate        DateTime        // From purchase.createdAt
  section         PricingSection? // From purchase.product.pricingSection
  commissionAmount Decimal        @db.Decimal(10, 2) // 10% of purchase.totalAmount
  status          CommissionStatus @default(PENDING)
  approvedBy      String?         // Staff ID who approved (Level 3+)
  approvedAt      DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  purchase Purchase @relation(fields: [purchaseId], references: [id])
  agentStaff Staff? @relation(fields: [agentStaffId], references: [id])
  approver  Staff?  @relation("CommissionApprover", fields: [approvedBy], references: [id])

  @@index([status])
  @@index([agentStaffId])
  @@index([saleDate])
  @@index([company])
}

////////////////////
/// SMS NOTIFICATIONS
////////////////////

model SmsOutbox {
  id        String              @id @default(uuid()) @db.Uuid
  eventType SmsOutboxEventType
  payload   Json                // Event-specific payload (e.g., { burialId: "..." })
  status    String              @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  retryCount Int                @default(0)
  maxRetries Int                @default(3)
  errorMessage String?           @db.Text
  processedAt DateTime?
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  smsLogs SmsLog[]

  @@index([status])
  @@index([eventType])
  @@index([createdAt])
}

model SmsLog {
  id              String      @id @default(uuid()) @db.Uuid
  outboxId        String?     @db.Uuid
  recipientPhone  String       // E.164 format
  messageBody     String       @db.Text
  category        SmsCategory
  twilioMessageSid String?    // Twilio Message SID
  status          SmsStatus   @default(QUEUED)
  errorMessage    String?     @db.Text
  sentAt          DateTime?
  deliveredAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  outbox SmsOutbox? @relation(fields: [outboxId], references: [id], onDelete: SetNull)

  @@index([outboxId])
  @@index([status])
  @@index([category])
  @@index([recipientPhone])
  @@index([twilioMessageSid])
  @@index([createdAt])
}
